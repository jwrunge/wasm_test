<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>hello-wasm example</title>
  </head>
  <body>
    <script type="module">
        let wasm = null;
        const wasmPath = "./target/wasm32-unknown-unknown/release/wasm_test.wasm";
        WebAssembly.instantiateStreaming(fetch(wasmPath), {
            imports: {
                imported_func: arg => {
                    console.log(arg);
                }
            }
        })
        .then(results=> {
            console.log(results);
            wasm = results?.instance?.exports || null;
        })
        .catch(err=> {
            console.error(err);
        });

        function wasmString(loc, len) {
            const mem = new Uint8Array(wasm?.memory?.buffer, loc, len);
            console.log(mem);
            const dec = new TextDecoder();
            return dec.decode(mem);
        }

        setTimeout(()=> {
            console.log(wasm)
            if(wasm) {
                let ab = (new TextEncoder()).encode("WebAssembly");
                const memLoc = wasm.greet(ab);
                const len = wasm.greet_len(ab);
                console.log(memLoc, len);
                const str = wasmString(memLoc, len);
                console.log(str);
            }
            else {
                alert("Bad news: no WASM :-(")
            }
        }, 2000)
    </script>
  </body>
</html>
